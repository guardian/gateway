stacks:
  - identity
regions:
  - eu-west-1
deployments:
  gateway-cloudformation:
    type: cloud-formation
    app: identity-gateway
    parameters:
      cloudFormationStackName: gateway
      amiParametersToTags:
        AMIIdentitygateway:
          BuiltBy: amigo
          AmigoStage: PROD
          Recipe: gateway-arm64
          Encrypted: 'true'
        AMI:
          BuiltBy: amigo
          AmigoStage: PROD
          Recipe: gateway-arm64
          Encrypted: 'true'
      templateStagePaths:
        CODE: IdentityGateway-euwest-1-CODE.template.json
        PROD: IdentityGateway-euwest-1-PROD.template.json
      templateParameters:
        VpcId: /account/vpc/primary/id
    dependencies:
      - update-ami
  identity-gateway:
    type: autoscaling
    dependencies:
      - gateway-cloudformation
    parameters:
      bucketSsmLookup: true
      bucketSsmKey: /account/services/identity.artifact.bucket
      prefixStack: false
      asgMigrationInProgress: true
  update-ami:
    type: ami-cloudformation-parameter
    parameters:
      cloudFormationStackByTags: false
      cloudFormationStackName: gateway
      amiParametersToTags:
        AMI:
          Recipe: gateway-arm64
          AmigoStage: PROD
      amiEncrypted: true
