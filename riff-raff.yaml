stacks:
  - identity
regions:
  - eu-west-1
deployments:
  gateway-cloudformation:
    type: cloud-formation
    app: identity-gateway
    parameters:
      cloudFormationStackName: gateway
      amiParametersToTags:
        AMIIdentitygateway:
          Recipe: gateway-arm64
          AmigoStage: PROD
      templateStagePaths:
        CODE: IdentityGateway-euwest-1-CODE.template.json
        PROD: IdentityGateway-euwest-1-PROD.template.json
      amiEncrypted: true
      templateParameters:
        # This seems to be a slight bug in Cloudformation/RiffRaff.
        # Whenever an existing String parameter is converted into an SSM String parameter the deployment fails,
        # this is because RiffRaffs default behaviour is to copy the previous value, which doesn't work because the parameter type has changed.
        # This workaround can be removed once the Parameter type change has been applied to production.
        VpcId: /account/vpc/primary/id
  identity-gateway:
    type: autoscaling
    dependencies:
      - gateway-cloudformation
    parameters:
      bucketSsmLookup: true
      bucketSsmKey: /account/services/identity.artifact.bucket
      prefixStack: false
